name: Deploy to Firebase

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci --ignore-scripts
          echo "‚úÖ Main dependencies installed"
          echo "üì¶ Installing functions dependencies separately..."
          cd functions && npm ci || echo "‚ö†Ô∏è Functions install failed (this might be expected)"
          cd ..
          echo "üìã Verifying key dependencies..."
          npm list vite vue @vitejs/plugin-vue

      - name: Build project
        run: |
          echo "üèóÔ∏è Starting build process..."
          echo "Current working directory: $(pwd)"
          echo "Node.js version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Available scripts:"
          npm run --list
          
          echo "üîç Checking environment variables..."
          echo "NODE_ENV: $NODE_ENV"
          echo "IS_DEV: $IS_DEV" 
          echo "IS_PROD: $IS_PROD"
          echo "VITE_FIREBASE_PROJECT_ID: ${VITE_FIREBASE_PROJECT_ID:0:10}..." # Only show first 10 chars for security
          
          echo "üîç Checking if vite is available..."
          npx vite --version || echo "Vite not found"
          
          echo "üèóÔ∏è Trying direct vite build first..."
          npx vite build --mode production 2>&1 | tee direct-build.log || echo "Direct vite build failed"
          
          echo "üìÅ Checking for dist after direct build..."
          if [ -d "dist" ]; then
            echo "‚úÖ Direct vite build created dist directory"
            ls -la dist/
          else
            echo "‚ùå Direct vite build did not create dist directory"
            echo "Running custom build script instead..."
            npm run build -- --mode production 2>&1 | tee custom-build.log
            CUSTOM_EXIT_CODE=${PIPESTATUS[0]}
            if [ $CUSTOM_EXIT_CODE -ne 0 ]; then
              echo "‚ùå Custom build also failed! Logs:"
              echo "=== Direct Build Log ==="
              cat direct-build.log || echo "No direct build log"
              echo "=== Custom Build Log ==="
              cat custom-build.log || echo "No custom build log"
              exit $CUSTOM_EXIT_CODE
            fi
          fi
        env:
          NODE_ENV: production
          ENVIRONMENT: production
          IS_DEV: "false"
          IS_PROD: "true"
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

      - name: Verify dist directory exists
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Error: dist directory was not created during build"
            echo "Listing current directory contents:"
            ls -la
            exit 1
          fi
          echo "‚úÖ dist directory exists"
          echo "Contents of dist directory:"
          ls -la dist/

      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KINDA_FUN }}
          channelId: live
          projectId: kinda-fun
