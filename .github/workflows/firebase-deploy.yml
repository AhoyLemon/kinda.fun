name: Deploy to Firebase

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci --ignore-scripts
          echo "‚úÖ Main dependencies installed"
          echo "üì¶ Installing functions dependencies separately..."
          cd functions && npm ci || echo "‚ö†Ô∏è Functions install failed (this might be expected)"
          cd ..
          echo "üìã Verifying key dependencies..."
          npm list nuxt vue

      - name: Build project
        run: |
          echo "üèóÔ∏è Starting Nuxt build process..."
          echo "Current working directory: $(pwd)"
          echo "Node.js version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "üèóÔ∏è Running Nuxt generate..."
          npm run build
        env:
          NODE_ENV: production
          ENVIRONMENT: production
          IS_DEV: "false"
          IS_PROD: "true"
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

      - name: Verify .output/public directory exists
        run: |
          if [ ! -d ".output/public" ]; then
            echo "‚ùå Error: .output/public directory was not created during build"
            echo "Listing current directory contents:"
            ls -la
            exit 1
          fi
          echo "‚úÖ .output/public directory exists"
          echo "Contents of .output/public directory:"
          ls -la .output/public/

      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KINDA_FUN }}
          channelId: live
          projectId: kinda-fun
